# üöÄ GUIDE SYST√àME TEMPS R√âEL ECOSYSTIA

## üìã **Vue d'ensemble**

Ce guide vous accompagne dans la configuration compl√®te du syst√®me temps r√©el pour EcosystIA, incluant :
- **R√©plication temps r√©el** de toutes les tables critiques
- **Sauvegarde automatique** des formulaires
- **Notifications instantan√©es** aux utilisateurs
- **Synchronisation en direct** des donn√©es
- **Abonnements WebSocket** pour les mises √† jour

---

## üèóÔ∏è **√âTAPE 1: Configuration Supabase**

### 1.1 Ex√©cution du script de configuration
1. Ouvrez votre dashboard Supabase
2. Allez dans l'onglet **"SQL Editor"**
3. Copiez le contenu du fichier `database/realtime_setup.sql`
4. Collez-le dans l'√©diteur et cliquez sur **"Run"**

**‚úÖ R√©sultat attendu :**
- R√©plication activ√©e sur 7 tables critiques
- 7 triggers temps r√©el cr√©√©s
- 9 fonctions utilitaires configur√©es
- Index optimis√©s pour les performances

### 1.2 Tables avec r√©plication temps r√©el
```sql
-- Tables r√©pliqu√©es automatiquement
users                    -- Profils utilisateurs
projects                 -- Projets principaux
project_team_members     -- Membres d'√©quipe
tasks                    -- T√¢ches et sous-t√¢ches
courses                  -- Cours et formations
jobs                     -- Offres d'emploi
time_logs               -- Logs de temps
leave_requests          -- Demandes de cong√©s
invoices                -- Factures
expenses                -- D√©penses
contacts                -- Contacts CRM
documents               -- Base de connaissances
notifications           -- Notifications utilisateur
system_logs             -- Logs syst√®me
```

---

## üîß **√âTAPE 2: Configuration de l'Application**

### 2.1 Service temps r√©el
Le service `realtimeService.ts` fournit :
- **Abonnements** aux changements de donn√©es
- **Sauvegarde automatique** des formulaires
- **Gestion des notifications** temps r√©el
- **Synchronisation** des √©tats

### 2.2 Hooks React disponibles
```typescript
// Hook principal pour les abonnements
const { subscribe, unsubscribe, isConnected } = useRealtime();

// Hook pour l'auto-save
const { autoSaveState, saveNow } = useAutoSave(formId, saveFunction, getFormData);

// Hook pour les notifications
const { notifications, unreadCount, markAsRead } = useRealtimeNotifications(userId);

// Hook pour les donn√©es projet temps r√©el
const { projectData, isLoading } = useProjectRealtime(projectId);

// Hook pour les statistiques utilisateur
const { stats } = useUserRealtimeStats(userId);
```

---

## üì° **√âTAPE 3: Abonnements Temps R√©el**

### 3.1 S'abonner aux changements de projet
```typescript
useEffect(() => {
  const unsubscribe = realtimeService.subscribeToUserProjects(userId, (event) => {
    if (event.type === 'INSERT') {
      // Nouveau projet cr√©√©
      console.log('Nouveau projet:', event.record);
    } else if (event.type === 'UPDATE') {
      // Projet modifi√©
      console.log('Projet mis √† jour:', event.record);
    }
  });

  return () => unsubscribe.unsubscribe();
}, [userId]);
```

### 3.2 S'abonner aux t√¢ches d'un projet
```typescript
useEffect(() => {
  const unsubscribe = realtimeService.subscribeToProjectTasks(projectId, (event) => {
    // Mettre √† jour la liste des t√¢ches en temps r√©el
    setTasks(prevTasks => {
      if (event.type === 'INSERT') {
        return [...prevTasks, event.record];
      } else if (event.type === 'UPDATE') {
        return prevTasks.map(task => 
          task.id === event.record.id ? event.record : task
        );
      } else if (event.type === 'DELETE') {
        return prevTasks.filter(task => task.id !== event.record.id);
      }
      return prevTasks;
    });
  });

  return () => unsubscribe.unsubscribe();
}, [projectId]);
```

### 3.3 S'abonner aux notifications
```typescript
useEffect(() => {
  const unsubscribe = realtimeService.subscribeToUserNotifications(userId, (event) => {
    if (event.type === 'INSERT') {
      // Nouvelle notification
      showNotification(event.record.title, event.record.message);
    }
  });

  return () => unsubscribe.unsubscribe();
}, [userId]);
```

---

## üíæ **√âTAPE 4: Sauvegarde Automatique**

### 4.1 Configuration de l'auto-save
```typescript
const MyForm = () => {
  const [formData, setFormData] = useState({});
  
  const saveFunction = async (data) => {
    const response = await fetch('/api/save-form', {
      method: 'POST',
      body: JSON.stringify(data)
    });
    return response.ok;
  };

  const { autoSaveState, saveNow } = useAutoSave(
    'my-form',
    saveFunction,
    () => formData,
    {
      intervalMs: 30000, // Sauvegarder toutes les 30 secondes
      enabled: true
    }
  );

  return (
    <div>
      <form>
        {/* Votre formulaire */}
      </form>
      
      <AutoSaveIndicator state={autoSaveState} />
    </div>
  );
};
```

### 4.2 √âtats d'auto-save
```typescript
interface AutoSaveState {
  isSaving: boolean;        // Sauvegarde en cours
  lastSaved: Date | null;   // Derni√®re sauvegarde
  hasUnsavedChanges: boolean; // Modifications non sauvegard√©es
  error: string | null;     // Erreur de sauvegarde
}
```

---

## üîî **√âTAPE 5: Notifications Temps R√©el**

### 5.1 Cr√©er une notification
```typescript
const createNotification = async () => {
  await realtimeService.createNotification(
    userId,
    'Nouveau projet',
    'Un nouveau projet a √©t√© cr√©√©',
    'info',
    '/projects/123',
    { projectId: 123 }
  );
};
```

### 5.2 Composant de notifications
```typescript
const Header = () => {
  return (
    <header>
      <RealtimeNotifications 
        className="text-gray-600"
        showCount={true}
        maxNotifications={5}
      />
    </header>
  );
};
```

### 5.3 Types de notifications
- **info** : Information g√©n√©rale
- **success** : Succ√®s d'une action
- **warning** : Avertissement
- **error** : Erreur critique

---

## üìä **√âTAPE 6: Donn√©es Temps R√©el**

### 6.1 Statistiques utilisateur en temps r√©el
```typescript
const Dashboard = () => {
  const { user } = useAuth();
  const { stats, isLoading } = useUserRealtimeStats(user?.id);

  if (isLoading) return <div>Chargement...</div>;

  return (
    <div>
      <h2>Projets actifs: {stats?.active_projects}</h2>
      <h2>T√¢ches termin√©es: {stats?.completed_tasks}</h2>
      <h2>Temps logg√© aujourd'hui: {stats?.time_logged_today}h</h2>
    </div>
  );
};
```

### 6.2 Donn√©es projet temps r√©el
```typescript
const ProjectDetail = ({ projectId }) => {
  const { projectData, isLoading } = useProjectRealtime(projectId);

  if (isLoading) return <div>Chargement...</div>;

  return (
    <div>
      <h1>{projectData?.project?.title}</h1>
      <div>√âquipe: {projectData?.team?.length} membres</div>
      <div>T√¢ches: {projectData?.tasks?.length}</div>
    </div>
  );
};
```

---

## ‚ö° **√âTAPE 7: Optimisations Performance**

### 7.1 Index optimis√©s
```sql
-- Index pour les notifications
CREATE INDEX idx_notifications_user_status ON notifications(user_id, status);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);

-- Index pour les logs de temps
CREATE INDEX idx_time_logs_user_date ON time_logs(user_id, date);
CREATE INDEX idx_time_logs_project_date ON time_logs(project_id, date);

-- Index pour les t√¢ches
CREATE INDEX idx_tasks_project_status ON tasks(project_id, status);
CREATE INDEX idx_tasks_assignee_status ON tasks(assignee_id, status);
```

### 7.2 Fonctions optimis√©es
```sql
-- Fonction pour les statistiques utilisateur
SELECT get_user_realtime_stats('user-id');

-- Fonction pour les donn√©es projet
SELECT get_project_realtime_data(project_id);
```

---

## üß™ **√âTAPE 8: Tests et Validation**

### 8.1 Test de r√©plication
```javascript
// Ex√©cuter le script de test
node scripts/testRealtimeSystem.js
```

### 8.2 Tests manuels
1. **Ouvrir deux onglets** de l'application
2. **Modifier des donn√©es** dans un onglet
3. **V√©rifier la synchronisation** dans l'autre onglet
4. **Tester les notifications** en temps r√©el
5. **Valider l'auto-save** des formulaires

### 8.3 M√©triques de performance
- **Latence WebSocket** : < 100ms
- **Temps de sauvegarde** : < 500ms
- **Temps de notification** : < 200ms
- **M√©moire utilis√©e** : < 50MB pour 1000 connexions

---

## üîß **D√âPANNAGE**

### Probl√®me : Pas de synchronisation
**Solution :**
1. V√©rifier que la r√©plication est activ√©e
2. V√©rifier les triggers dans Supabase
3. V√©rifier la connexion WebSocket

### Probl√®me : Auto-save ne fonctionne pas
**Solution :**
1. V√©rifier la fonction de sauvegarde
2. V√©rifier les permissions utilisateur
3. V√©rifier les erreurs dans la console

### Probl√®me : Notifications manquantes
**Solution :**
1. V√©rifier les politiques RLS
2. V√©rifier la table notifications
3. V√©rifier les abonnements WebSocket

### Probl√®me : Performance d√©grad√©e
**Solution :**
1. V√©rifier les index de base de donn√©es
2. Limiter le nombre d'abonnements
3. Optimiser les requ√™tes

---

## üìà **M√âTRIQUES DE SUCC√àS**

### ‚úÖ Syst√®me op√©rationnel si :
- [x] **R√©plication** activ√©e sur toutes les tables
- [x] **Triggers** temps r√©el fonctionnels
- [x] **Abonnements** WebSocket √©tablis
- [x] **Auto-save** op√©rationnel
- [x] **Notifications** temps r√©el
- [x] **Synchronisation** des donn√©es
- [x] **Performance** acceptable

### üìä Indicateurs de performance :
- **Latence** : < 100ms pour les mises √† jour
- **Disponibilit√©** : 99.9% uptime
- **Connexions simultan√©es** : 1000+ utilisateurs
- **D√©bit** : 10,000+ √©v√©nements/minute

---

## üöÄ **FONCTIONNALIT√âS AVANC√âES**

### üîÑ Synchronisation bidirectionnelle
```typescript
// √âcouter les changements et synchroniser
useEffect(() => {
  const unsubscribe = realtimeService.subscribeToTable('projects', (event) => {
    // Synchroniser avec le state local
    syncLocalState(event);
  });
  
  return () => unsubscribe.unsubscribe();
}, []);
```

### üì± Notifications push
```typescript
// Int√©gration avec les notifications push du navigateur
const requestNotificationPermission = async () => {
  if ('Notification' in window) {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      // Configurer les notifications push
    }
  }
};
```

### üîÑ Reconnection automatique
```typescript
// Gestion de la reconnexion automatique
useEffect(() => {
  const handleReconnect = () => {
    // Reconnecter les abonnements
    realtimeService.reconnect();
  };

  window.addEventListener('online', handleReconnect);
  return () => window.removeEventListener('online', handleReconnect);
}, []);
```

---

## üìû **SUPPORT**

### Documentation technique :
- **Configuration** : `database/realtime_setup.sql`
- **Service** : `services/realtimeService.ts`
- **Hooks** : `hooks/useRealtime.ts`
- **Composants** : `components/common/`

### Scripts de test :
- **Test complet** : `scripts/testRealtimeSystem.js`
- **Test de performance** : Tests automatis√©s inclus

### Ressources Supabase :
- [Documentation Realtime](https://supabase.com/docs/guides/realtime)
- [Guide WebSocket](https://supabase.com/docs/guides/realtime/websockets)
- [API Reference](https://supabase.com/docs/reference/javascript/realtime)

---

## üéâ **F√âLICITATIONS !**

Votre syst√®me temps r√©el EcosystIA est maintenant configur√© et op√©rationnel !

**üöÄ Votre plateforme dispose de :**
- ‚úÖ Synchronisation temps r√©el compl√®te
- ‚úÖ Sauvegarde automatique intelligente
- ‚úÖ Notifications instantan√©es
- ‚úÖ Performance optimis√©e
- ‚úÖ Reconnexion automatique
- ‚úÖ Gestion d'erreurs robuste

**üìà Pr√™t pour :**
- Collaboration en temps r√©el
- Sauvegarde automatique des donn√©es
- Notifications instantan√©es
- Synchronisation multi-utilisateurs
- Performance √† grande √©chelle

**‚ú® Bon d√©veloppement avec EcosystIA Temps R√©el !**
